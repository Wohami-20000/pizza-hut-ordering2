<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pizza Hut - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f3f4f6;
    }
    .order-card {
      transition: all 0.3s ease;
    }
    .order-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body class="p-4 md:p-8 max-w-6xl mx-auto text-gray-900">
  <header class="bg-white shadow-md rounded-lg p-6 mb-8">
    <div class="flex justify-between items-center">
      <h1 class="text-3xl font-bold flex items-center text-red-600">
        <i class="fas fa-pizza-slice mr-3"></i> Pizza Hut Admin
        <span id="new-order-badge" class="ml-2 bg-red-600 text-white text-sm font-semibold px-2 py-1 rounded-full hidden">New</span>
      </h1>
      <div>
        <button id="mark-as-read" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300 hidden mr-2">
          <i class="fas fa-check mr-2"></i>Mark as Read
        </button>
        <button id="logout" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
          <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </button>
      </div>
    </div>
  </header>

  <div id="statistics" class="grid grid-cols-1 sm:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
    <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
      <div class="bg-blue-100 p-3 rounded-full mr-4">
        <i class="fas fa-clipboard-list text-blue-600 text-2xl"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-600">Total Orders</h2>
        <p id="total-orders" class="text-3xl font-bold text-blue-600">0</p>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
      <div class="bg-yellow-100 p-3 rounded-full mr-4">
        <i class="fas fa-clock text-yellow-600 text-2xl"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-600">Pending Orders</h2>
        <p id="pending-orders" class="text-3xl font-bold text-yellow-600">0</p>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
      <div class="bg-green-100 p-3 rounded-full mr-4">
        <i class="fas fa-check-circle text-green-600 text-2xl"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-600">Completed Orders</h2>
        <p id="completed-orders-count" class="text-3xl font-bold text-green-600">0</p>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
      <div class="bg-purple-100 p-3 rounded-full mr-4">
        <i class="fas fa-utensils text-purple-600 text-2xl"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-600">Preparing Orders</h2>
        <p id="preparing-orders" class="text-3xl font-bold text-purple-600">0</p>
      </div>
    </div>
    <div class="bg-white rounded-lg shadow-md p-6 flex items-center">
      <div class="bg-green-100 p-3 rounded-full mr-4">
        <i class="fas fa-dollar-sign text-green-600 text-2xl"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-600">Total Revenue</h2>
        <p id="total-revenue" class="text-3xl font-bold text-green-600">0 MAD</p>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4">
      <input id="search-bar" type="text" placeholder="Search by table #" class="border p-2 rounded-lg w-full md:w-64 mb-2 md:mb-0" />
      <select id="status-filter" class="border p-2 rounded-lg w-full md:w-auto">
        <option value="">All Statuses</option>
        <option value="pending">Pending</option>
        <option value="preparing">Preparing</option>
        <option value="completed">Completed</option>
      </select>
    </div>
    <button onclick="window.print()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-300">
      <i class="fas fa-print mr-2"></i>Print Orders
    </button>
  </div>

  <div class="bg-white rounded-lg shadow-md p-6 mb-8">
  <h2 class="text-2xl font-bold mb-4 text-gray-800">Menu Management</h2>

  <div class="mb-6">
    <h3 class="text-xl font-semibold mb-3 text-gray-700">Categories</h3>
    <div id="categories-list" class="space-y-2 mb-3">
      </div>
    <input type="text" id="new-category-name" placeholder="New category name" class="border p-2 rounded-lg w-full md:w-auto mb-2">
    <button id="add-category-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Category</button>
  </div>

  <div id="item-management-section" class="mb-6">
    <h3 class="text-xl font-semibold mb-3 text-gray-700">Manage Items for: <span id="current-editing-category" class="text-red-600"></span></h3>
    <div id="items-list" class="space-y-2 mb-3">
      </div>
    <h4 class="text-lg font-medium mb-2">Add New Item</h4>
    <input type="text" id="new-item-name" placeholder="Item Name" class="border p-2 rounded-lg w-full mb-2">
    <textarea id="new-item-desc" placeholder="Item Description (optional)" class="border p-2 rounded-lg w-full mb-2"></textarea>
    <input type="number" id="new-item-price" placeholder="Price (DH)" class="border p-2 rounded-lg w-full mb-2">
    <button id="add-item-btn" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">Add Item</button>
  </div>
</div>

<script src="admin-menu.js"></script>

  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Active Orders</h2>
    <div id="active-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <div class="mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Completed Orders</h2>
    <div id="completed-orders" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
  </div>

  <div id="pagination" class="flex justify-center items-center mt-8 space-x-2"></div>

  <div id="order-modal" class="fixed inset-0 bg-gray-800 bg-opacity-50 hidden flex items-center justify-center z-50" aria-hidden="true">
    <div class="bg-white w-full max-w-md rounded-lg shadow-lg p-6 overflow-y-auto max-h-[90vh]">
      <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800">Order Details</h2>
      <div id="modal-body" class="space-y-3"></div>
      <button id="close-modal" class="bg-red-600 text-white px-4 py-2 rounded-lg mt-6 hover:bg-red-700 transition duration-300">Close</button>
    </div>
  </div>

  <audio id="newOrderSound" src="https://assets.mixkit.co/sfx/preview/mixkit-bell-notification-933.mp3"></audio>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <script src="firebase.js"></script>
  <script>
    const auth = firebase.auth();
    const activeOrdersContainer = document.getElementById("active-orders");
    const completedOrdersContainer = document.getElementById("completed-orders");
    const paginationDiv = document.getElementById("pagination");
    const searchBar = document.getElementById("search-bar");
    const statusFilter = document.getElementById("status-filter");

    const modal = document.getElementById("order-modal");
    const modalBody = document.getElementById("modal-body");
    const closeModal = document.getElementById("close-modal");

    const totalOrdersEl = document.getElementById("total-orders");
    const totalRevenueEl = document.getElementById("total-revenue");
    const pendingOrdersEl = document.getElementById("pending-orders");
    const preparingOrdersEl = document.getElementById("preparing-orders");
    const completedOrdersEl = document.getElementById("completed-orders-count");

    const newOrderBadge = document.getElementById("new-order-badge");
    const markAsReadBtn = document.getElementById("mark-as-read");
    const logoutBtn = document.getElementById("logout");

    let allOrders = [];
    let activeOrders = [];
    let completedOrders = [];
    let currentPage = 1;
    const ORDERS_PER_PAGE = 20;

    let pendingOrdersSeen = sessionStorage.getItem("pendingOrdersSeen") === "true";

    function escapeHTML(str) {
      return String(str).replace(/[<>&"']/g, s => ({ "<": "&lt;", ">": "&gt;", "&": "&amp;", '"': "&quot;", "'": "&#39;" }[s]));
    }

    function updateStatistics() {
      const totalOrders = allOrders.length;
      const totalRevenue = allOrders.reduce((sum, { order }) => sum + order.total, 0);
      const pendingOrders = allOrders.filter(({ order }) => order.status === "pending").length;
      const preparingOrders = allOrders.filter(({ order }) => order.status === "preparing").length;
      const completedOrders = allOrders.filter(({ order }) => order.status === "completed").length;

      totalOrdersEl.textContent = totalOrders;
      totalRevenueEl.textContent = `${totalRevenue} MAD`;
      pendingOrdersEl.textContent = pendingOrders;
      preparingOrdersEl.textContent = preparingOrders;
      completedOrdersEl.textContent = completedOrders;

      if (pendingOrders > 0 && !pendingOrdersSeen) {
        newOrderBadge.classList.remove("hidden");
        markAsReadBtn.classList.remove("hidden");
        document.getElementById("newOrderSound").play();
      } else {
        newOrderBadge.classList.add("hidden");
        markAsReadBtn.classList.add("hidden");
      }
    }

    function deleteOrder(orderId) {
      if (confirm("Are you sure you want to delete this order?")) {
        db.ref(`orders/${orderId}`).remove()
          .then(() => console.log(`Order ${orderId} deleted successfully`))
          .catch(error => console.error("Error deleting order:", error));
      }
    }

    function updateOrderStatus(orderId, newStatus) {
      db.ref(`orders/${orderId}/status`).set(newStatus)
        .then(() => console.log(`Order ${orderId} status updated to ${newStatus}`))
        .catch(error => console.error("Error updating order status:", error));
    }

    function renderOrder(order, id) {
      const div = document.createElement("div");
      div.className = "order-card bg-white rounded-lg shadow-md p-4 relative";
      div.innerHTML = `
        <h2 class="font-bold text-lg mb-2 text-gray-800">Table #${escapeHTML(order.table)}</h2>
        <p class="text-sm text-gray-600 mb-2">Placed: ${new Date(order.timestamp).toLocaleString()}</p>
        <p class="font-semibold mb-2 text-gray-700">Status: 
          <select class="status-dropdown border rounded p-1" data-order-id="${id}">
            <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
            <option value="preparing" ${order.status === 'preparing' ? 'selected' : ''}>Preparing</option>
            <option value="ready" ${order.status === 'ready' ? 'selected' : ''}>Ready</option>
            <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
            <option value="canceled" ${order.status === 'canceled' ? 'selected' : ''}>Canceled</option>
          </select>
        </p>
        <ul class="mb-3 text-gray-600">
          ${order.items.map(i => `<li>${i.qty} x ${escapeHTML(i.name)} (${i.price} MAD)</li>`).join("")}
        </ul>
        <p class="font-semibold text-gray-800">Total: ${order.total} MAD</p>
        <button onclick="viewOrderDetails('${id}')" class="text-blue-600 hover:text-blue-800 underline mt-2 transition duration-300">View Details</button>
        <button onclick="deleteOrder('${id}')" class="absolute top-2 right-2 text-red-500 hover:text-red-700 transition duration-300">
          <i class="fas fa-trash"></i>
        </button>
      `;
      return div;
    }

    function renderOrders() {
      activeOrdersContainer.innerHTML = "";
      completedOrdersContainer.innerHTML = "";

      activeOrders.forEach(({ id, order }) => {
        activeOrdersContainer.appendChild(renderOrder(order, id));
      });

      completedOrders.forEach(({ id, order }) => {
        completedOrdersContainer.appendChild(renderOrder(order, id));
      });

      // Add event listeners to status dropdowns
      document.querySelectorAll('.status-dropdown').forEach(dropdown => {
        dropdown.addEventListener('change', (e) => {
          const orderId = e.target.getAttribute('data-order-id');
          const newStatus = e.target.value;
          updateOrderStatus(orderId, newStatus);
        });
      });
    }

    function applyFilters() {
      const searchTerm = searchBar.value.toLowerCase();
      const status = statusFilter.value;

      activeOrders = allOrders.filter(({ order }) => {
        const matchesSearch = order.table.toString().includes(searchTerm);
        const matchesStatus = status ? order.status === status : true;
        return matchesSearch && matchesStatus && order.status !== 'completed';
      });

      completedOrders = allOrders.filter(({ order }) => {
        const matchesSearch = order.table.toString().includes(searchTerm);
        return matchesSearch && order.status === 'completed';
      });

      renderOrders();
    }

    function viewOrderDetails(orderId) {
      const order = allOrders.find(({ id }) => id === orderId)?.order;
      if (!order) return;

      modalBody.innerHTML = `
        <p><strong>Table Number:</strong> ${order.table}</p>
        <p><strong>Status:</strong> <span class="capitalize">${escapeHTML(order.status)}</span></p>
        <p><strong>Total:</strong> ${order.total} MAD</p>
        <ul>
          ${order.items.map(i => `<li>${i.qty} x ${escapeHTML(i.name)} (${i.price} MAD)</li>`).join("")}
        </ul>
      `;
      modal.classList.remove("hidden");
      modal.setAttribute("aria-hidden", "false");
    }

    closeModal.addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.setAttribute("aria-hidden", "true");
    });

    markAsReadBtn.addEventListener("click", () => {
      const updates = {};
      allOrders.forEach(({ id, order }) => {
        if (order.status === "pending") {
          updates[`${id}/status`] = "preparing";
        }
      });
      if (Object.keys(updates).length) {
        db.ref("orders").update(updates)
          .then(() => {
            pendingOrdersSeen = true;
            sessionStorage.setItem("pendingOrdersSeen", "true");
            newOrderBadge.classList.add("hidden");
            markAsReadBtn.classList.add("hidden");
          })
          .catch(console.error);
      }
    });

    logoutBtn.addEventListener("click", () => {
      auth.signOut().then(() => {
        window.location.href = "admin-login.html";
      });
    });

    auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);

    auth.onAuthStateChanged(user => {
      if (!user) {
        window.location.href = "admin-login.html";
      } else {
        // Listen for all changes in the orders
        db.ref("orders").on("value", snapshot => {
          const data = snapshot.val();
          console.log("Orders data from Firebase:", data);
          if (!data) {
            allOrders = [];
          } else {
            allOrders = Object.entries(data).reverse().map(([id, order]) => ({ id, order }));
          }
          applyFilters();
          updateStatistics();
        });

        // Listen for specific changes to individual orders
        db.ref("orders").on("child_changed", snapshot => {
          const changedOrder = snapshot.val();
          const changedOrderId = snapshot.key;
          console.log(`Order ${changedOrderId} changed:`, changedOrder);
          
          // Update the order in allOrders
          const index = allOrders.findIndex(({ id }) => id === changedOrderId);
          if (index !== -1) {
            allOrders[index] = { id: changedOrderId, order: changedOrder };
            applyFilters();
            updateStatistics();
          }
        });

        // Listen for order deletions
        db.ref("orders").on("child_removed", snapshot => {
          const removedOrderId = snapshot.key;
          console.log(`Order ${removedOrderId} removed`);
          
          // Remove the order from allOrders
          allOrders = allOrders.filter(({ id }) => id !== removedOrderId);
          applyFilters();
          updateStatistics();
        });

        // Listen for new orders
        db.ref("orders").on("child_added", (snapshot) => {
          const newOrder = snapshot.val();
          if (newOrder.status === "pending") {
            playNewOrderSound();
            // Visual notification is already handled by the existing newOrderBadge
          }
        });
      }
    });

    searchBar.addEventListener("input", applyFilters);
    statusFilter.addEventListener("change", applyFilters);

    function playNewOrderSound() {
      document.getElementById('newOrderSound').play();
    }
  </script>
</body>
</html>