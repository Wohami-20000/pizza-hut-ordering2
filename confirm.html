<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pizza Hut - Order Confirmed</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
  </head>
<body class="bg-green-50 text-green-800 p-4 sm:p-6 min-h-screen flex flex-col items-center justify-center">

  <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg text-center">
    <i class="fas fa-check-circle text-6xl text-green-500 mb-6"></i>
    <h1 id="order-confirmed" class="text-3xl sm:text-4xl font-bold mb-3 text-gray-800">Thank you for your order!</h1>
    
    <div class="my-4">
      <label for="language-switcher" class="text-sm text-gray-600 mr-2">Language:</label>
      <select id="language-switcher" class="border border-gray-300 rounded p-1.5 text-sm focus:ring-2 focus:ring-red-500">
        <option value="en">English</option>
        <option value="fr">Français</option>
        <option value="ar">العربية</option>
      </select>
    </div>

    <p id="order-received" class="mb-6 text-gray-600 text-lg">Your order has been received and is being prepared.</p>

    <div id="order-summary-container" class="border-t border-b border-gray-200 py-6 my-6">
        <h2 id="summary-title" class="text-2xl font-semibold text-gray-700 mb-4">Order Summary</h2>
        <div id="order-summary" class="bg-gray-50 rounded-lg p-4 text-left space-y-2 text-sm sm:text-base">
            <p data-translate="loading_order_details">Loading order details...</p>
        </div>
    </div>


    <button id="done-btn" class="mt-6 w-full sm:w-auto bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 focus:bg-green-800 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
      Done
    </button>
  </div>

  <footer class="text-center p-4 text-gray-500 text-xs mt-8">
    &copy; <span id="current-year"></span> Pizza Hut Clone. For educational purposes.
  </footer>

  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <script src="firebase.js"></script> 
  
  <script src="lang.js"></script> 

  <script>
    // Initialize Firebase services ONCE
    const db = firebase.database();
    // const auth = firebase.auth(); // If needed for other purposes on this page

    function escapeHTML(str) {
      if (typeof str !== 'string') return str !== null && str !== undefined ? String(str) : '';
      return String(str).replace(/[&<>"']/g, s => ({
        "<": "&lt;", ">": "&gt;", "&": "&amp;", '"': "&quot;", "'": "&#39;"
      }[s]));
    }
    
    function displayOrderData(order, langKey) {
        const summaryDiv = document.getElementById("order-summary");
        const t = translations[langKey] || translations["en"]; // Fallback to English

        if (!summaryDiv) {
            console.error("Order summary div not found!");
            return;
        }
        if (!order || !order.items || !order.table || typeof order.total === 'undefined') {
            summaryDiv.innerHTML = `<p data-translate="no_order_data">${t.noOrderData || "Order data could not be displayed."}</p>`;
            return;
        }

        let html = `<p class="mb-2"><strong>${t.tableLabel || 'Table #'}</strong> <span class="text-red-600 font-semibold">${escapeHTML(order.table)}</span></p>`;
        if (order.timestamp) {
             html += `<p class="text-xs text-gray-500 mb-3"><strong>${t.order_placed_at || 'Placed at:'}</strong> ${new Date(order.timestamp).toLocaleString()}</p>`;
        }
        html += `<h4 class='font-semibold text-gray-700 mb-2'>${t.items || 'Items'}:</h4><ul class="list-disc list-inside pl-5 text-gray-600 space-y-1">`;
        
        order.items.forEach(item => {
          html += `<li>${item.qty} x ${escapeHTML(item.name)} - ${(parseFloat(item.price) || 0).toFixed(2)} MAD</li>`;
        });
        
        html += `</ul>`;
        html += `<p class="font-bold text-xl text-right mt-4 pt-3 border-t">${t.totalLabel || 'Total:'} <span class="text-red-600">${(parseFloat(order.total) || 0).toFixed(2)} MAD</span></p>`;
        if (order.status) {
            html += `<p class="mt-3 text-sm"><strong>${t.status || 'Status:'}</strong> <span class="capitalize text-blue-600 font-medium">${escapeHTML(order.status)}</span></p>`;
        }
        summaryDiv.innerHTML = html;
    }

    function applyLanguage(lang) {
      const t = translations[lang] || translations["en"];
      if (!t) return;
      
      document.getElementById("order-confirmed").textContent = t.orderConfirmed || "Thank you for your order!";
      document.getElementById("order-received").textContent = t.orderReceived || "Your order has been received and is being prepared.";
      document.getElementById("done-btn").textContent = t.done || "Done";
      document.getElementById("summary-title").textContent = t.order_summary_title || "Order Summary";
      
      // Re-render summary with new language if order data is already loaded
      if (window.currentOrderData) {
          displayOrderData(window.currentOrderData, lang);
      } else {
          // If order data not yet loaded, update the "loading" or "no data" message
          const summaryDiv = document.getElementById("order-summary");
          if (summaryDiv && summaryDiv.firstChild && summaryDiv.firstChild.hasAttribute('data-translate')) {
              const key = summaryDiv.firstChild.getAttribute('data-translate');
              summaryDiv.firstChild.textContent = t[key] || summaryDiv.firstChild.textContent;
          }
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
        console.log("confirm.html: DOMContentLoaded.");
        document.getElementById('current-year').textContent = new Date().getFullYear();
        
        let currentLang = localStorage.getItem("lang") || "en";
        const languageSwitcherConfirm = document.getElementById('language-switcher');
        if (languageSwitcherConfirm) {
            languageSwitcherConfirm.value = currentLang;
            languageSwitcherConfirm.addEventListener('change', (e) => {
                currentLang = e.target.value;
                localStorage.setItem('lang', currentLang);
                applyLanguage(currentLang);
            });
        }
        
        const params = new URLSearchParams(window.location.search);
        const orderId = params.get('orderId');
        window.currentOrderData = null; // To store fetched data

        if (orderId) {
            console.log("confirm.html: Found orderId in URL:", orderId);
            db.ref('orders/' + orderId).once('value')
                .then(snapshot => {
                    const orderDataFromFirebase = snapshot.val();
                    if (orderDataFromFirebase) {
                        console.log("confirm.html: Fetched order from Firebase:", orderDataFromFirebase);
                        window.currentOrderData = orderDataFromFirebase;
                        displayOrderData(orderDataFromFirebase, currentLang);
                    } else {
                        console.warn("confirm.html: Order ID found in URL, but no data in Firebase. Trying localStorage.");
                        const orderDataFromStorage = JSON.parse(localStorage.getItem("lastOrderDataForConfirm"));
                        if (orderDataFromStorage) {
                            console.log("confirm.html: Using order data from localStorage as fallback:", orderDataFromStorage);
                            window.currentOrderData = orderDataFromStorage;
                            displayOrderData(orderDataFromStorage, currentLang);
                        } else {
                            console.error("confirm.html: No order data found in Firebase or localStorage.");
                            document.getElementById("order-summary").innerHTML = `<p data-translate="no_order_data_found">${translations[currentLang].no_order_data_found || "Could not retrieve order details."}</p>`;
                        }
                    }
                })
                .catch(error => {
                    console.error("confirm.html: Error fetching order from Firebase:", error);
                    document.getElementById("order-summary").innerHTML = `<p data-translate="error_fetching_order">${translations[currentLang].error_fetching_order || "Error fetching order details."}</p>`;
                })
                .finally(() => {
                    // Apply language after attempting to load data, to ensure all texts are translated
                    if (typeof applyLanguage === 'function') {
                        applyLanguage(currentLang);
                    }
                });
        } else {
            console.warn("confirm.html: No orderId in URL. Trying localStorage for 'lastOrderDataForConfirm'.");
            const orderDataFromStorage = JSON.parse(localStorage.getItem("lastOrderDataForConfirm"));
            if (orderDataFromStorage) {
                console.log("confirm.html: Using order data from localStorage:", orderDataFromStorage);
                window.currentOrderData = orderDataFromStorage;
                displayOrderData(orderDataFromStorage, currentLang);
            } else {
                console.error("confirm.html: No orderId in URL and no data in localStorage.");
                document.getElementById("order-summary").innerHTML = `<p data-translate="no_order_data_found">${translations[currentLang].no_order_data_found || "No order details to display."}</p>`;
            }
            // Apply language after attempting to load data
            if (typeof applyLanguage === 'function') {
                applyLanguage(currentLang);
            }
        }

        const doneBtn = document.getElementById("done-btn");
        if (doneBtn) {
            doneBtn.addEventListener("click", () => {
              // No need to remove lastOrderDataForConfirm if we primarily use orderId from URL
              // localStorage.removeItem("lastOrderDataForConfirm"); 
              window.location.href = "menu.html"; // Go to menu instead of index?
            });
        }
    });
  </script>
</body>
</html>